# Seguridad y configuración básica
# -------------------------------------

# Evita listado de archivos
Options -Indexes

# Permite enlaces simbólicos
Options +FollowSymLinks

# Activa reescritura
RewriteEngine On

# Forzar HTTPS si hay certificado
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]


# Flutter Web sin hash (browser routing)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.html [L]

# -------------------------------------
# Compresión Brotli y GZIP
# -------------------------------------

<IfModule mod_brotli.c>
  BrotliCompressionQuality 6
  BrotliWindowSize 22
  AddOutputFilterByType BROTLI_COMPRESS ...
</IfModule>

<IfModule mod_deflate.c>
  SetEnvIfNoCase Request_URI \.br$ no-gzip
  AddOutputFilterByType DEFLATE ...
</IfModule>


# -------------------------------------
# Cache de recursos estáticos
# -------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML: no cache largo (para actualizaciones rápidas)
  ExpiresByType text/html "access plus 10 seconds"

  # Archivos estáticos con cache agresiva (1 año)
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/wasm "access plus 1 year"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType application/json "access plus 1 year"
</IfModule>

# -------------------------------------
# Encabezados de seguridad y performance
# -------------------------------------
<IfModule mod_headers.c>
  # Seguridad básica
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Referrer-Policy "strict-origin-when-cross-origin"

  # Cache-Control explícito
  <FilesMatch "\.(js|css|png|jpg|jpeg|gif|webp|svg|woff2|woff|wasm|json)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # HTML: evitar cache agresiva
  <FilesMatch "\.(html)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </FilesMatch>
</IfModule>